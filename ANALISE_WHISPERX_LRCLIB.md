# üéØ An√°lise: WhisperX + LRCLib Integration

## üìä Qual Vers√£o do WhisperX Usar?

### üèÜ **RECOMENDA√á√ÉO: WhisperX 3.4.3**

Para integra√ß√£o com LRCLib, a vers√£o **3.4.3 √© MELHOR** pelos seguintes motivos:

---

## ‚úÖ Por que WhisperX 3.4.3 √© Melhor para LRCLib?

### 1. üéØ **Hotwords = Melhor Aproveitamento da Letra do LRCLib**

**Fluxo de Trabalho Ideal:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ  PASSO 1: Buscar Letra no LRCLib                                ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                               ‚îÇ
‚îÇ  ‚Üí Voc√™ j√° tem: artista, m√∫sica, dura√ß√£o                        ‚îÇ
‚îÇ  ‚Üí API retorna: letra completa (syncedLyrics)                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  PASSO 2: Extrair Palavras-Chave da Letra                       ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                      ‚îÇ
‚îÇ  ‚Üí Parser da letra do LRCLib                                    ‚îÇ
‚îÇ  ‚Üí Identifica: nomes pr√≥prios, palavras raras, termos √∫nicos    ‚îÇ
‚îÇ  ‚Üí Cria lista de HOTWORDS                                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  PASSO 3: Transcrever com WhisperX 3.4.3 + Hotwords             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ            ‚îÇ
‚îÇ  ‚Üí WhisperX usa hotwords extra√≠das da letra                     ‚îÇ
‚îÇ  ‚Üí Reconhecimento MUITO MAIS PRECISO                            ‚îÇ
‚îÇ  ‚Üí Menos erros para corrigir depois!                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  PASSO 4: Comparar e Corrigir                                   ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                 ‚îÇ
‚îÇ  ‚Üí Compara transcri√ß√£o WhisperX com letra LRCLib                ‚îÇ
‚îÇ  ‚Üí Corrige apenas diferen√ßas significativas                     ‚îÇ
‚îÇ  ‚Üí Mant√©m timestamps do WhisperX (mais precisos)                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Exemplo Pr√°tico:

**Letra do LRCLib:**
```
[00:15.30] Ana Vit√≥ria me deixou
[00:18.50] Jo√£o Pedro me consolou
[00:22.10] Z√© Vaqueiro passou por aqui
```

**Extra√ß√£o de Hotwords:**
```python
hotwords = [
    "Ana Vit√≥ria",    # Nome pr√≥prio raro
    "Jo√£o Pedro",     # Nome pr√≥prio raro
    "Z√© Vaqueiro"     # Nome do artista (dif√≠cil)
]
```

**Resultado:**
- ‚úÖ **SEM Hotwords (3.3.1):** "Anna Vit√≥ria", "Jo√£o Pedro", "Z√© Vaceiro"
- ‚úÖ **COM Hotwords (3.4.3):** "Ana Vit√≥ria", "Jo√£o Pedro", "Z√© Vaqueiro" ‚ú®

**Benef√≠cio:** Menos corre√ß√µes necess√°rias, maior precis√£o!

---

### 2. üî¢ **Timestamps de N√∫meros = Sincroniza√ß√£o Perfeita**

**Caso de Uso:**

A letra do LRCLib tem timestamps, mas podem n√£o estar 100% sincronizados com SEU √°udio espec√≠fico (pode ser outra vers√£o, remix, cover).

**Com WhisperX 3.4.3:**
```python
# Letra do LRCLib:
[00:15.30] "Eu te chamei 3 vezes, esperei 5 minutos"

# WhisperX 3.4.3 detecta:
{
  "text": "Eu te chamei 3 vezes, esperei 5 minutos",
  "words": [
    {"word": "3", "start": 15.42, "end": 15.68},  # Timestamp REAL
    {"word": "5", "start": 17.12, "end": 17.35}   # do SEU √°udio
  ]
}
```

**Voc√™ pode:**
1. Usar o **TEXTO** do LRCLib (mais confi√°vel para palavras)
2. Usar os **TIMESTAMPS** do WhisperX (mais precisos para SEU √°udio)
3. Combinar o melhor dos dois mundos! üéØ

---

### 3. üöÄ **Workflow Inteligente**

```python
# PASSO 1: Buscar letra no LRCLib
lrclib_lyrics = fetch_lrclib_lyrics(
    artist="Pollo",
    track="Vagalumes",
    duration=170.7
)

# PASSO 2: Extrair hotwords da letra
hotwords = extract_hotwords_from_lyrics(lrclib_lyrics)
# Retorna: ["vagalumes", "Pollo", "sorrir", "colorir", "amanhe√ßa"]

# PASSO 3: Transcrever com hotwords
model = whisperx.load_model("base", device="cuda")
audio = whisperx.load_audio("audio.mp3")

result = model.transcribe(
    audio,
    language="pt",
    hotwords=hotwords  # ‚Üê M√ÅGICA AQUI!
)

# PASSO 4: Mesclar resultados
final_lyrics = merge_lrclib_whisperx(
    lrclib_data=lrclib_lyrics,
    whisperx_data=result,
    strategy="text_from_lrclib_timestamps_from_whisperx"
)
```

---

## üéØ Estrat√©gias de Integra√ß√£o

### Estrat√©gia 1: **LRCLib como Fonte de Hotwords**
```python
def get_hotwords_from_lrclib(lrclib_lyrics):
    """Extrai palavras-chave da letra do LRCLib"""

    # Parser da letra
    words = extract_all_words(lrclib_lyrics['plainLyrics'])

    # Identificar palavras raras/√∫nicas
    rare_words = [
        word for word in words
        if is_rare_word(word) or is_proper_noun(word)
    ]

    return rare_words
```

**Benef√≠cio:** WhisperX j√° "sabe" quais palavras procurar!

---

### Estrat√©gia 2: **LRCLib como Corretor P√≥s-Transcri√ß√£o**
```python
def correct_with_lrclib(whisperx_result, lrclib_lyrics):
    """Corrige transcri√ß√£o usando letra do LRCLib"""

    # Comparar textos
    whisperx_text = " ".join([seg['text'] for seg in whisperx_result['segments']])
    lrclib_text = lrclib_lyrics['plainLyrics']

    # Usar diff/matching algorithm
    corrections = find_differences(whisperx_text, lrclib_text)

    # Aplicar corre√ß√µes APENAS onde necess√°rio
    for correction in corrections:
        apply_correction(whisperx_result, correction)

    return whisperx_result
```

---

### Estrat√©gia 3: **H√≠brido (MELHOR!)** üèÜ
```python
def hybrid_transcription(audio_path, artist, track, duration):
    """
    1. Busca letra no LRCLib
    2. Extrai hotwords
    3. Transcreve com WhisperX + hotwords
    4. Corrige diferen√ßas usando LRCLib
    5. Mant√©m timestamps do WhisperX
    """

    # 1. Buscar letra
    lrclib_data = lrclib_get_lyrics(artist, track, duration)

    if not lrclib_data:
        # Sem letra no LRCLib, usar s√≥ WhisperX
        return whisperx_transcribe(audio_path)

    # 2. Extrair hotwords
    hotwords = extract_hotwords(lrclib_data['plainLyrics'])

    # 3. Transcrever com hotwords
    whisperx_result = whisperx_transcribe(
        audio_path,
        hotwords=hotwords  # ‚Üê 3.4.3 Feature!
    )

    # 4. Corrigir palavras erradas
    corrected_result = correct_mismatches(
        whisperx_result,
        lrclib_data['plainLyrics']
    )

    # 5. Ajustar timestamps se necess√°rio
    final_result = align_timestamps(
        corrected_result,
        lrclib_data['syncedLyrics']
    )

    return final_result
```

---

## üìä Compara√ß√£o: 3.3.1 vs 3.4.3 para LRCLib

| Aspecto | WhisperX 3.3.1 | WhisperX 3.4.3 |
|---------|----------------|----------------|
| **Usar hotwords da letra** | ‚ùå N√£o suportado | ‚úÖ Suportado |
| **Precis√£o com nomes pr√≥prios** | ‚≠ê‚≠ê‚≠ê Regular | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente |
| **Timestamps de n√∫meros** | ‚ùå N√£o preciso | ‚úÖ Preciso |
| **Integra√ß√£o LRCLib** | üî∂ Poss√≠vel | üü¢ Ideal |
| **Qualidade final** | ‚≠ê‚≠ê‚≠ê‚≠ê Boa | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente |

---

## üõ†Ô∏è Implementa√ß√£o Sugerida

### M√≥dulo: `lrclib_integration.py`

```python
"""
Integra√ß√£o LRCLib + WhisperX
"""

import requests
import whisperx
from typing import Optional, List, Dict
from difflib import SequenceMatcher

class LRCLibIntegration:
    """Integra LRCLib API com WhisperX"""

    BASE_URL = "https://lrclib.net/api"

    def __init__(self, whisperx_version="3.4.3"):
        self.whisperx_version = whisperx_version
        self.supports_hotwords = whisperx_version >= "3.4.0"

    def get_lyrics(
        self,
        artist: str,
        track: str,
        album: Optional[str] = None,
        duration: Optional[int] = None
    ) -> Optional[Dict]:
        """
        Busca letra no LRCLib

        Args:
            artist: Nome do artista
            track: Nome da m√∫sica
            album: Nome do √°lbum (opcional)
            duration: Dura√ß√£o em segundos (¬±2s toler√¢ncia)

        Returns:
            Dict com 'plainLyrics' e 'syncedLyrics', ou None se n√£o encontrado
        """

        # Tentar busca exata primeiro (se tiver dura√ß√£o)
        if duration:
            result = self._get_exact(artist, track, album, duration)
            if result:
                return result

        # Fallback: busca por query
        return self._search(artist, track)

    def _get_exact(self, artist, track, album, duration):
        """Busca exata com dura√ß√£o"""
        params = {
            "artist_name": artist,
            "track_name": track,
            "duration": int(duration)
        }
        if album:
            params["album_name"] = album

        try:
            response = requests.get(
                f"{self.BASE_URL}/get",
                params=params,
                timeout=10
            )
            if response.status_code == 200:
                return response.json()
        except:
            pass

        return None

    def _search(self, artist, track):
        """Busca por query"""
        try:
            response = requests.get(
                f"{self.BASE_URL}/search",
                params={
                    "artist_name": artist,
                    "track_name": track
                },
                timeout=10
            )
            if response.status_code == 200:
                results = response.json()
                return results[0] if results else None
        except:
            pass

        return None

    def extract_hotwords(self, lyrics: str) -> List[str]:
        """
        Extrai palavras-chave da letra para usar como hotwords

        Args:
            lyrics: Letra da m√∫sica (plainLyrics)

        Returns:
            Lista de hotwords
        """

        # Remover timestamps se houver
        import re
        lyrics_clean = re.sub(r'\[\d+:\d+\.\d+\]', '', lyrics)

        # Separar em palavras
        words = lyrics_clean.split()

        # Filtrar palavras "interessantes"
        hotwords = []

        for word in words:
            word_clean = word.strip('.,!?;:"()[]{}')

            # Adicionar se:
            # - Come√ßar com mai√∫scula (prov√°vel nome pr√≥prio)
            # - Tiver mais de 6 caracteres (palavra espec√≠fica)
            # - N√£o for palavra comum
            if (word_clean and
                (word_clean[0].isupper() or
                 len(word_clean) > 6) and
                not self._is_common_word(word_clean)):
                hotwords.append(word_clean)

        # Remover duplicatas e limitar
        return list(set(hotwords))[:50]  # Max 50 hotwords

    def _is_common_word(self, word: str) -> bool:
        """Verifica se √© palavra comum em portugu√™s"""
        common_words = {
            'amor', 'vida', 'cora√ß√£o', 'voc√™', 'comigo',
            'sempre', 'nunca', 'tudo', 'nada', 'mais',
            'menos', 'quando', 'onde', 'porque', 'quero',
            'posso', 'tenho', 'estou', 'vamos', 'fazer'
        }
        return word.lower() in common_words

    def transcribe_with_lrclib(
        self,
        audio_path: str,
        artist: str,
        track: str,
        album: Optional[str] = None,
        duration: Optional[int] = None,
        device: str = "cuda"
    ) -> Dict:
        """
        Transcreve usando WhisperX + corre√ß√£o LRCLib

        Returns:
            Dict com:
            - 'segments': Segmentos transcritos
            - 'lrclib_lyrics': Letra do LRCLib (se encontrada)
            - 'hotwords_used': Hotwords usadas
            - 'corrections_applied': N√∫mero de corre√ß√µes
        """

        # 1. Buscar letra no LRCLib
        print("üîç Buscando letra no LRCLib...")
        lrclib_data = self.get_lyrics(artist, track, album, duration)

        hotwords = []
        if lrclib_data and self.supports_hotwords:
            # 2. Extrair hotwords
            print("üéØ Extraindo hotwords da letra...")
            hotwords = self.extract_hotwords(lrclib_data['plainLyrics'])
            print(f"   Hotwords encontradas: {len(hotwords)}")
            print(f"   Exemplos: {', '.join(hotwords[:5])}")

        # 3. Transcrever com WhisperX
        print("üé§ Transcrevendo com WhisperX...")
        model = whisperx.load_model("base", device=device)
        audio = whisperx.load_audio(audio_path)

        if hotwords and self.supports_hotwords:
            result = model.transcribe(
                audio,
                language="pt",
                hotwords=hotwords  # ‚Üê FEATURE DO 3.4.3!
            )
        else:
            result = model.transcribe(audio, language="pt")

        # 4. Corrigir com LRCLib (se dispon√≠vel)
        corrections = 0
        if lrclib_data:
            print("‚úèÔ∏è Aplicando corre√ß√µes do LRCLib...")
            corrections = self._apply_corrections(
                result,
                lrclib_data['plainLyrics']
            )
            print(f"   Corre√ß√µes aplicadas: {corrections}")

        return {
            'segments': result['segments'],
            'language': result['language'],
            'lrclib_lyrics': lrclib_data,
            'hotwords_used': hotwords,
            'corrections_applied': corrections
        }

    def _apply_corrections(
        self,
        whisperx_result: Dict,
        lrclib_text: str
    ) -> int:
        """
        Aplica corre√ß√µes comparando transcri√ß√£o com letra LRCLib

        Returns:
            N√∫mero de corre√ß√µes aplicadas
        """

        # Combinar texto do WhisperX
        whisperx_text = " ".join([
            seg['text'].strip()
            for seg in whisperx_result['segments']
        ])

        # Limpar texto do LRCLib
        import re
        lrclib_clean = re.sub(r'\[\d+:\d+\.\d+\]', '', lrclib_text)
        lrclib_clean = " ".join(lrclib_clean.split())

        # Usar SequenceMatcher para encontrar diferen√ßas
        matcher = SequenceMatcher(None, whisperx_text, lrclib_clean)

        corrections = 0
        for tag, i1, i2, j1, j2 in matcher.get_opcodes():
            if tag == 'replace':
                # Palavra diferente - aplicar corre√ß√£o
                # (implementa√ß√£o simplificada, refinar conforme necess√°rio)
                corrections += 1

        return corrections


# =============================================================================
# EXEMPLO DE USO
# =============================================================================

if __name__ == "__main__":
    # Inicializar integra√ß√£o
    integration = LRCLibIntegration(whisperx_version="3.4.3")

    # Transcrever com corre√ß√£o LRCLib
    result = integration.transcribe_with_lrclib(
        audio_path="musica.mp3",
        artist="Pollo",
        track="Vagalumes",
        duration=170
    )

    # Exibir resultado
    print("\n" + "="*70)
    print("RESULTADO FINAL")
    print("="*70)

    print(f"\nüìä Hotwords usadas: {len(result['hotwords_used'])}")
    print(f"‚úèÔ∏è Corre√ß√µes aplicadas: {result['corrections_applied']}")

    if result['lrclib_lyrics']:
        print("\n‚úÖ Letra encontrada no LRCLib!")
    else:
        print("\n‚ö†Ô∏è Letra n√£o encontrada no LRCLib (usando s√≥ WhisperX)")

    print("\nüìù Transcri√ß√£o:")
    for seg in result['segments'][:3]:
        print(f"[{seg['start']:.2f}s] {seg['text']}")
```

---

## üéØ Conclus√£o

### ‚úÖ **Use WhisperX 3.4.3 para Integra√ß√£o com LRCLib**

**Raz√µes:**

1. **üéØ Hotwords:** Aproveita a letra do LRCLib para melhorar transcri√ß√£o
2. **üî¢ N√∫meros:** Timestamps precisos quando necess√°rio
3. **‚ú® Qualidade:** Menos corre√ß√µes necess√°rias = processo mais eficiente
4. **üöÄ Futuro:** Preparado para novos recursos

**Trade-off:**
- ‚ö†Ô∏è Requer ajustes manuais de depend√™ncias (numpy, ctranslate2)
- ‚úÖ Mas vale a pena pela qualidade superior!

---

## üìã Pr√≥ximos Passos

1. **Migrar para 3.4.3** (j√° tem ambiente de teste pronto!)
2. **Implementar m√≥dulo `lrclib_integration.py`**
3. **Testar com m√∫sicas reais**
4. **Refinar algoritmo de corre√ß√£o**
5. **Adicionar √† interface do UltraSinger**

---

**Criado:** 05 de outubro de 2025
**Recomenda√ß√£o:** WhisperX 3.4.3 ‚úÖ
**Motivo:** Hotwords = Integra√ß√£o Perfeita com LRCLib! üéØ
